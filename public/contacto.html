<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comparte tus datos de contacto con Agencia Modelos Argentinas. Formulario r√°pido y seguro.">
    <meta name="theme-color" content="#0483B8">
    <title>Formulario de Contacto - Agencia Modelos Argentinas</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëó</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <script src="utils.js" defer></script>
    <!-- Contact Picker API polyfill para mejor compatibilidad -->
    <script src="https://cdn.jsdelivr.net/npm/contact-picker-polyfill@0.1.0/dist/contact-picker-polyfill.min.js" defer></script>
</head>
<body>
    <div class="container">
        <div class="card contact-form">
            <h1>üìù Comparte tus Datos</h1>
            <p class="subtitle">Completa el formulario para compartir tu informaci√≥n de contacto</p>
            <div id="autoFillHint" class="auto-fill-hint" style="display: none;">
                üí° <strong>Tip:</strong> Toca cualquier campo y tu navegador sugerir√° autom√°ticamente tus datos guardados
            </div>
            
            <form id="contactForm">
                <div class="form-group">
                    <label for="nombre">Nombre completo *</label>
                    <input 
                        type="text" 
                        id="nombre" 
                        name="nombre" 
                        required 
                        placeholder="Tu nombre"
                        autocomplete="name"
                        autofocus
                    >
                </div>
                
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        required 
                        placeholder="tu@email.com"
                        autocomplete="email"
                    >
                </div>
                
                <div class="form-group">
                    <label for="telefono">Tel√©fono</label>
                    <input 
                        type="tel" 
                        id="telefono" 
                        name="telefono" 
                        placeholder="+1 234 567 8900"
                        autocomplete="tel"
                    >
                </div>
                
                <div class="form-group">
                    <label for="empresa">Empresa</label>
                    <input 
                        type="text" 
                        id="empresa" 
                        name="empresa" 
                        placeholder="Nombre de tu empresa"
                        autocomplete="organization"
                    >
                </div>
                
                <div class="form-group">
                    <label for="mensaje">Mensaje adicional (opcional)</label>
                    <textarea 
                        id="mensaje" 
                        name="mensaje" 
                        rows="4" 
                        placeholder="Escribe un mensaje si lo deseas..."
                    ></textarea>
                </div>
                
                <button type="submit" class="btn-submit">
                    <span id="submitText">Enviar Informaci√≥n</span>
                    <span id="submitLoader" class="loader" style="display: none;"></span>
                </button>
                
                <div id="message" class="message"></div>
            </form>
        </div>
    </div>
    
    <script>
        // Funci√≥n para detectar y llenar informaci√≥n del dispositivo autom√°ticamente
        async function llenarFormularioAutomaticamente() {
            const nombreField = document.getElementById('nombre');
            const emailField = document.getElementById('email');
            const telefonoField = document.getElementById('telefono');
            
            // Si los campos ya tienen valores, no hacer nada
            if (nombreField.value || emailField.value || telefonoField.value) {
                return;
            }
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Estrategia 1: Intentar Contact Picker API autom√°ticamente (solo en m√≥viles)
            if (isMobile && 'contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const supportedProperties = await navigator.contacts.getProperties();
                    const hasSupport = supportedProperties.some(prop => ['name', 'email', 'tel'].includes(prop));
                    
                    if (hasSupport) {
                        // Intentar abrir el selector de contactos autom√°ticamente
                        // Esto mostrar√° un di√°logo al usuario, pero es la mejor opci√≥n disponible
                        const contacts = await navigator.contacts.select(['name', 'email', 'tel'], { multiple: false });
                        if (contacts && contacts.length > 0) {
                            const contact = contacts[0];
                            if (contact.name && contact.name.length > 0) {
                                nombreField.value = contact.name[0];
                            }
                            if (contact.email && contact.email.length > 0) {
                                emailField.value = contact.email[0];
                            }
                            if (contact.tel && contact.tel.length > 0) {
                                telefonoField.value = contact.tel[0];
                            }
                            if (window.toast) {
                                toast.success('‚úÖ Informaci√≥n cargada autom√°ticamente');
                            }
                            return true; // √âxito
                        }
                    }
                } catch (error) {
                    // Si el usuario cancela, continuar con otras estrategias
                    if (error.name !== 'AbortError') {
                        console.log('Contact Picker no disponible:', error);
                    }
                }
            }
            
            // Estrategia 2: Activar autocomplete del navegador enfocando el primer campo
            // Esto har√° que el navegador muestre sugerencias autom√°ticamente
            setTimeout(() => {
                nombreField.focus();
                // En algunos navegadores m√≥viles, esto activa el autocomplete
                nombreField.click();
            }, 300);
            
            return false;
        }
        
        // Funci√≥n para mostrar bot√≥n de seleccionar contacto
        async function mostrarSelectorContacto() {
            const nombreField = document.getElementById('nombre');
            const emailField = document.getElementById('email');
            const telefonoField = document.getElementById('telefono');
            
            // Verificar si Contact Picker API est√° disponible
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    // Verificar propiedades soportadas
                    const supportedProperties = await navigator.contacts.getProperties();
                    const hasSupport = supportedProperties.some(prop => ['name', 'email', 'tel'].includes(prop));
                    
                    if (hasSupport) {
                        // Crear bot√≥n si no existe
                        let btnContacto = document.getElementById('btnSeleccionarContacto');
                        if (!btnContacto) {
                            btnContacto = document.createElement('button');
                            btnContacto.type = 'button';
                            btnContacto.id = 'btnSeleccionarContacto';
                            btnContacto.className = 'btn-contacto-selector';
                            btnContacto.innerHTML = 'üì± Llenar desde mis contactos';
                            btnContacto.onclick = async () => {
                                try {
                                    const contacts = await navigator.contacts.select(['name', 'email', 'tel'], { multiple: false });
                                    if (contacts && contacts.length > 0) {
                                        const contact = contacts[0];
                                        if (contact.name && contact.name.length > 0) {
                                            nombreField.value = contact.name[0];
                                        }
                                        if (contact.email && contact.email.length > 0) {
                                            emailField.value = contact.email[0];
                                        }
                                        if (contact.tel && contact.tel.length > 0) {
                                            telefonoField.value = contact.tel[0];
                                        }
                                        if (window.toast) {
                                            toast.success('Informaci√≥n de contacto cargada');
                                        }
                                    }
                                } catch (error) {
                                    if (error.name !== 'AbortError' && window.toast) {
                                        toast.error('Error al seleccionar contacto');
                                    }
                                }
                            };
                            
                            // Insertar despu√©s del subt√≠tulo
                            const subtitle = document.querySelector('.subtitle');
                            if (subtitle) {
                                subtitle.parentNode.insertBefore(btnContacto, subtitle.nextSibling);
                            } else {
                                // Si no hay subt√≠tulo, insertar antes del formulario
                                const form = document.getElementById('contactForm');
                                const firstGroup = form.querySelector('.form-group');
                                if (firstGroup) {
                                    firstGroup.parentNode.insertBefore(btnContacto, firstGroup);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.log('Contact Picker API no disponible:', error);
                }
            }
        }
        
        // Obtener par√°metro de modelo de la URL y llenar formulario autom√°ticamente
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const modelo = urlParams.get('modelo');
            if (modelo) {
                const mensajeField = document.getElementById('mensaje');
                const currentValue = mensajeField.value;
                mensajeField.value = currentValue ? 
                    `${currentValue}\n\nInteresado en: ${decodeURIComponent(modelo)}` : 
                    `Interesado en: ${decodeURIComponent(modelo)}`;
            }
            
            // Detectar si viene de un QR (referrer vac√≠o o directo)
            const vieneDeQR = !document.referrer || document.referrer === '' || 
                              document.referrer.includes(window.location.hostname);
            
            // Mostrar hint sobre autocomplete
            const hint = document.getElementById('autoFillHint');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile && hint) {
                hint.style.display = 'block';
                // Ocultar despu√©s de 5 segundos
                setTimeout(() => {
                    if (hint) hint.style.opacity = '0';
                }, 5000);
            }
            
            // Si viene de un QR, intentar llenar autom√°ticamente
            if (vieneDeQR) {
                // Peque√±o delay para asegurar que todo est√© cargado
                setTimeout(async () => {
                    const llenado = await llenarFormularioAutomaticamente();
                    
                    // Si no se pudo llenar autom√°ticamente, mostrar el bot√≥n de contacto
                    if (!llenado) {
                        await mostrarSelectorContacto();
                    }
                }, 500);
            } else {
                // Si no viene de QR, solo mostrar el bot√≥n
                mostrarSelectorContacto();
            }
        });

        document.getElementById('contactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.querySelector('.btn-submit');
            const submitText = document.getElementById('submitText');
            const submitLoader = document.getElementById('submitLoader');
            const messageDiv = document.getElementById('message');
            
            // Mostrar loading
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            submitLoader.style.display = 'inline-block';
            messageDiv.textContent = '';
            messageDiv.className = 'message';
            
            // Recopilar datos del formulario
            const formData = {
                nombre: document.getElementById('nombre').value.trim(),
                email: document.getElementById('email').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                empresa: document.getElementById('empresa').value.trim(),
                mensaje: document.getElementById('mensaje').value.trim()
            };
            
            // Validaci√≥n b√°sica
            if (!formData.nombre || !formData.email) {
                const errorMsg = 'Por favor completa los campos requeridos (Nombre y Email)';
                messageDiv.textContent = errorMsg;
                messageDiv.className = 'message error';
                if (window.toast) toast.error(errorMsg);
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitLoader.style.display = 'none';
                return;
            }
            
            // Validar email
            if (window.utils && !utils.validateEmail(formData.email)) {
                const errorMsg = 'Por favor ingresa un email v√°lido';
                messageDiv.textContent = errorMsg;
                messageDiv.className = 'message error';
                if (window.toast) toast.error(errorMsg);
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitLoader.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch('/api/contacto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const successMsg = data.message || '¬°Gracias! Tu informaci√≥n ha sido recibida.';
                    messageDiv.textContent = successMsg;
                    messageDiv.className = 'message success';
                    if (window.toast) toast.success(successMsg);
                    document.getElementById('contactForm').reset();
                    
                    setTimeout(() => {
                        messageDiv.textContent = 'Gracias por tu informaci√≥n. Puedes cerrar esta p√°gina.';
                    }, 2000);
                } else {
                    const errorMsg = data.message || 'Hubo un error al enviar tus datos. Por favor, intenta nuevamente.';
                    messageDiv.textContent = errorMsg;
                    messageDiv.className = 'message error';
                    if (window.toast) toast.error(errorMsg);
                }
            } catch (error) {
                console.error('Error enviando formulario:', error);
                const errorMsg = 'Error de conexi√≥n. Por favor, verifica tu conexi√≥n a internet e intenta nuevamente.';
                messageDiv.textContent = errorMsg;
                messageDiv.className = 'message error';
                if (window.toast) toast.error(errorMsg);
            } finally {
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitLoader.style.display = 'none';
            }
        });
    </script>
</body>
</html>

